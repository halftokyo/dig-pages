<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>东京米其林推荐餐厅（¥20,000 以下）</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="css/medium-style.css" />
    <link rel="stylesheet" href="css/restaurant-page.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="logo">dig</a>
        </div>
    </nav>

    <div class="container">
        <header class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">¥20,000以内 · 东京米其林餐厅精选</h1>
                <p class="hero-subtitle">预算友好，体验不打折。享受米其林星级美食，从这一份精选开始。</p>
            </div>
        </header>

        <!-- Clay风格的筛选器 -->
        <section class="filter-section">
            <!-- 搜索和筛选栏 -->
            <div class="search-filter-bar">
                <!-- 搜索框 -->
                <div class="search-box">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" placeholder="搜索餐厅名称..." class="search-input" id="searchInput">
                </div>
                
                <!-- 价格筛选下拉 -->
                <select id="priceFilter" class="filter-select">
                    <option value="">价格区间</option>
                    <option value="¥5,000 以下">¥5,000 以下</option>
                    <option value="¥5,000–¥10,000">¥5,000–¥10,000</option>
                    <option value="¥10,000–¥20,000">¥10,000–¥20,000</option>
                </select>
                
                <!-- 地区筛选下拉 -->
                <select id="areaFilter" class="filter-select">
                    <option value="">所在地区</option>
                    <option value="千代田区">千代田区</option>
                    <option value="中央区">中央区</option>
                    <option value="港区">港区</option>
                    <option value="新宿区">新宿区</option>
                    <option value="渋谷区">渋谷区</option>
                    <option value="杉並区">杉並区</option>
                </select>
            </div>
            
            <!-- 菜系筛选标签 -->
            <div class="filter-tags">
                <button onclick="filterByCuisine('')" class="filter-tag active">全部菜系</button>
                <button onclick="filterByCuisine('拉面')" class="filter-tag">拉面</button>
                <button onclick="filterByCuisine('猪排')" class="filter-tag">猪排</button>
                <button onclick="filterByCuisine('荞麦')" class="filter-tag">荞麦</button>
                <button onclick="filterByCuisine('天妇罗')" class="filter-tag">天妇罗</button>
                <button onclick="filterByCuisine('法国料理')" class="filter-tag">法国料理</button>
                <button onclick="filterByCuisine('印度料理')" class="filter-tag">印度料理</button>
                <button onclick="filterByCuisine('日本料理')" class="filter-tag">日本料理</button>
                <button onclick="filterByCuisine('寿司')" class="filter-tag">寿司</button>
                <button onclick="filterByCuisine('烧鸟')" class="filter-tag">烧鸟</button>
                <button onclick="filterByCuisine('意大利料理')" class="filter-tag">意大利料理</button>
                <button onclick="filterByCuisine('鳗鱼')" class="filter-tag">鳗鱼</button>
                <button onclick="filterByCuisine('饭团')" class="filter-tag">饭团</button>
                <button onclick="filterByCuisine('西餐')" class="filter-tag">西餐</button>
            </div>
            
            <!-- 结果统计和重置 -->
            <div class="filter-footer">
                <button onclick="resetFilters()" class="reset-btn">重置筛选</button>
                <span id="resultCount" class="result-count"></span>
            </div>
        </section>

        <section>
            <h2 class="title-section">精选餐厅推荐</h2>
            <div id="restaurantList" class="restaurant-grid">
            </div>
        </section>
    </div>

    <script>
        let restaurants = [];
        let allRestaurants = [];

        // 从JSON文件加载餐厅数据
        async function loadRestaurants() {
            try {
                const response = await fetch('tokyo-under-20k-restaurants.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                console.log('加载的数据:', data.length, '家餐厅');

                // 转换JSON数据格式为页面所需格式
                allRestaurants = data.map(restaurant => ({
                    name: restaurant.name_en,
                    jpName: restaurant.name_jp,
                    type: restaurant.michelin_type || "推荐",
                    cuisine: mapCuisineType(restaurant.cuisine),
                    area: restaurant.ward,
                    rating: restaurant.tabelog_rating,
                    price: restaurant.price_estimate,
                    priceTier: mapPriceTier(restaurant.price_estimate),
                    reservable: restaurant.online_booking ? "是" : "否",
                    reason: restaurant.tabelog_review_summary,
                    website: restaurant.website
                }));

                restaurants = allRestaurants;
                console.log('转换后的数据:', restaurants.length, '家餐厅');
                renderList(restaurants);
                updateFilterButtons();
            } catch (error) {
                console.error('加载餐厅数据失败:', error);
                // 显示错误信息
                const restaurantList = document.getElementById('restaurantList');
                if (restaurantList) {
                    restaurantList.innerHTML =
                        '<div class="col-span-full text-center text-red-600 p-8">数据加载失败，请刷新页面重试<br><small>错误信息: ' + error.message + '</small></div>';
                }
            }
        }

        // 映射菜系类型（现在都是中文，直接返回）
        function mapCuisineType(cuisine) {
            return cuisine;
        }

        // 映射价格区间
        function mapPriceTier(priceEstimate) {
            if (!priceEstimate) return "未知";

            // 提取价格数字，处理各种格式
            const priceMatch = priceEstimate.match(/¥(\d+(?:,\d+)?)/g);
            if (!priceMatch) return "未知";

            const prices = priceMatch.map(p => parseInt(p.replace(/¥|,/g, '')));
            const maxPrice = Math.max(...prices);

            if (maxPrice <= 5000) return "¥5,000 以下";
            if (maxPrice <= 10000) return "¥5,000–¥10,000";
            return "¥10,000–¥20,000";
        }

        // 更新筛选按钮
        function updateFilterButtons() {
            // 获取所有独特的菜系类型
            const cuisines = [...new Set(allRestaurants.map(r => r.cuisine))];
            const areas = [...new Set(allRestaurants.map(r => r.area))];

            // 更新移动端菜系按钮
            updateCuisineButtons(cuisines);
            // 更新地区选择器
            updateAreaSelectors(areas);
        }

        function updateCuisineButtons(cuisines) {
            console.log('更新菜系按钮:', cuisines);

            // 移动端菜系按钮更新
            const mobileContainer = document.querySelector('.mobile-filter .filter-buttons');
            if (mobileContainer) {
                // 保留"全部"按钮，清除其他按钮
                const buttons = mobileContainer.querySelectorAll('button:not([onclick="filterByCuisine(\'\')"])');
                buttons.forEach(btn => btn.remove());

                // 添加新的菜系按钮
                cuisines.sort().forEach(cuisine => {
                    const button = document.createElement('button');
                    button.onclick = () => filterByCuisine(cuisine);
                    button.className = 'filter-btn';
                    button.textContent = cuisine;
                    mobileContainer.appendChild(button);
                });
            }

            // 桌面端菜系按钮更新
            const desktopContainer = document.querySelector('.desktop-filter .filter-group:nth-child(2) .filter-buttons');
            if (desktopContainer) {
                // 保留"全部"按钮，清除其他按钮
                const buttons = desktopContainer.querySelectorAll('button:not([onclick="filterByCuisine(\'\')"])');
                buttons.forEach(btn => btn.remove());

                // 添加新的菜系按钮
                cuisines.sort().forEach(cuisine => {
                    const button = document.createElement('button');
                    button.onclick = () => filterByCuisine(cuisine);
                    button.className = 'filter-btn';
                    button.textContent = cuisine;
                    desktopContainer.appendChild(button);
                });
            }
        }

        function updateAreaSelectors(areas) {
            console.log('更新地区选择器:', areas);

            // 更新移动端地区选择器
            const mobileAreaSelect = document.getElementById('mobileAreaFilter');
            if (mobileAreaSelect) {
                // 清除现有选项（保留第一个"所在地区"选项）
                while (mobileAreaSelect.children.length > 1) {
                    mobileAreaSelect.removeChild(mobileAreaSelect.lastChild);
                }

                // 添加新的地区选项
                areas.sort().forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    mobileAreaSelect.appendChild(option);
                });
            }

            // 更新桌面端地区按钮
            const desktopContainer = document.querySelector('.desktop-filter .filter-group:nth-child(3) .filter-buttons');
            if (desktopContainer) {
                // 保留"全部"按钮，清除其他按钮
                const buttons = desktopContainer.querySelectorAll('button:not([onclick="filterByArea(\'\')"])');
                buttons.forEach(btn => btn.remove());

                // 添加新的地区按钮
                areas.sort().forEach(area => {
                    const button = document.createElement('button');
                    button.onclick = () => filterByArea(area);
                    button.className = 'filter-btn';
                    button.textContent = area;
                    desktopContainer.appendChild(button);
                });
            }
        }

        const list = document.getElementById("restaurantList");

        function renderList(data) {
            if (!list) return;

            list.innerHTML = data.map(r => {
                // 处理米其林等级显示
                let typeDisplay = '';
                let typeClass = '';

                if (r.type === '一星') {
                    typeDisplay = '一星';
                    typeClass = 'michelin-badge michelin-one-star';
                } else if (r.type === '二星') {
                    typeDisplay = '二星';
                    typeClass = 'michelin-badge michelin-two-star';
                } else if (r.type === '必比登') {
                    typeDisplay = '必比登';
                    typeClass = 'michelin-badge michelin-bib';
                } else {
                    typeDisplay = '推荐';
                    typeClass = 'michelin-badge michelin-recommended';
                }

                return `
        <div class="restaurant-card">
          <div class="restaurant-card-header">
            <div class="restaurant-logo">${(r.jpName || r.name).charAt(0)}</div>
            ${r.website ? `<a href="${r.website}" target="_blank" class="apply-btn">查看详情</a>` : '<span class="apply-btn" style="opacity: 0.5;">暂无链接</span>'}
          </div>
          <div class="restaurant-content">
            <span class="${typeClass}">${typeDisplay}</span>
            <h3 class="restaurant-title">${r.jpName || r.name}</h3>
            <p class="restaurant-subtitle">${r.cuisine}</p>
            <p class="restaurant-location">${r.area} · ${r.price}</p>
            <div class="restaurant-info-grid">
              <div class="restaurant-info-item">
                <span class="restaurant-info-label">评分：</span>${r.rating ? r.rating + '/5' : '暂无评分'}
              </div>
              <div class="restaurant-info-item">
                <span class="restaurant-info-label">预约：</span>
                <span class="${r.reservable === '是' ? 'reservation-available' : 'reservation-unavailable'}">
                  ${r.reservable === '是' ? '可预约' : '不可预约'}
                </span>
              </div>
            </div>
          </div>
        </div>`;
            }).join("");

            // 更新结果计数
            updateResultCount(data.length);
        }

        let currentFilters = {
            search: '',
            price: '',
            cuisine: '',
            area: ''
        };

        function filterByCuisine(cuisine) {
            currentFilters.cuisine = cuisine;
            updateButtons('.filter-tag', `[onclick="filterByCuisine('${cuisine}')"]`);
            applyFilters();
        }

        function updateButtons(selector, activeSelector) {
            document.querySelectorAll(selector).forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(activeSelector);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function updateResultCount(count) {
            const countText = `共 ${count} 家餐厅`;
            const resultCountEl = document.getElementById('resultCount');
            if (resultCountEl) resultCountEl.textContent = countText;
        }

        function applyFilters() {
            let result = [...restaurants];

            // 搜索筛选
            if (currentFilters.search) {
                const searchTerm = currentFilters.search.toLowerCase();
                result = result.filter(r => 
                    (r.name && r.name.toLowerCase().includes(searchTerm)) ||
                    (r.jpName && r.jpName.toLowerCase().includes(searchTerm)) ||
                    (r.cuisine && r.cuisine.toLowerCase().includes(searchTerm))
                );
            }

            // 价格筛选
            if (currentFilters.price) {
                result = result.filter(r => r.priceTier === currentFilters.price);
            }

            // 菜系筛选
            if (currentFilters.cuisine) {
                result = result.filter(r => r.cuisine === currentFilters.cuisine);
            }

            // 地区筛选
            if (currentFilters.area) {
                result = result.filter(r => r.area === currentFilters.area);
            }

            renderList(result);
        }

        function resetFilters() {
            currentFilters = {
                search: '',
                price: '',
                cuisine: '',
                area: ''
            };

            // 重置所有输入
            document.getElementById('searchInput').value = '';
            document.getElementById('priceFilter').value = '';
            document.getElementById('areaFilter').value = '';

            // 重置菜系标签
            updateButtons('.filter-tag', `[onclick="filterByCuisine('')"]`);

            renderList(restaurants);
        }

        // 搜索功能
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const priceFilter = document.getElementById('priceFilter');
            const areaFilter = document.getElementById('areaFilter');

            // 搜索输入事件
            searchInput.addEventListener('input', function() {
                currentFilters.search = this.value;
                applyFilters();
            });

            // 价格筛选事件
            priceFilter.addEventListener('change', function() {
                currentFilters.price = this.value;
                applyFilters();
            });

            // 地区筛选事件
            areaFilter.addEventListener('change', function() {
                currentFilters.area = this.value;
                applyFilters();
            });

            // 加载餐厅数据
            loadRestaurants();
        });


    </script>
</body>

</html>