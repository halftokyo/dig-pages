<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>东京米其林推荐餐厅（¥20,000 以下）</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="css/clay-style.css" />
    <link rel="stylesheet" href="css/restaurant-page.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Clay风格的导航栏 -->
    <nav class="clay-navbar">
        <div class="clay-navbar-container">
            <a href="index.html" class="clay-logo">dig</a>
        </div>
    </nav>

    <div class="clay-container">
        <header class="clay-bg-white clay-p-8">
            <div class="clay-text-center">
                <h1 class="clay-heading-1">¥20,000以内 · 东京米其林餐厅精选</h1>
                <p class="clay-text-lg clay-text-gray-600 clay-mb-0" style="max-width: 600px; margin: 0 auto;">
                    预算友好，体验不打折。享受米其林星级美食，从这一份精选开始。</p>
            </div>
        </header>

        <!-- 筛选器 -->
        <section class="filter-section">
            <!-- 移动端筛选 -->
            <div class="mobile-filter">
                <div class="filter-group">
                    <div class="grid grid-cols-2 gap-3">
                        <!-- 价格筛选下拉 -->
                        <div>
                            <select id="mobilePriceFilter" class="mobile-filter-select">
                                <option value="">价格区间</option>
                                <option value="¥5,000 以下">¥5,000 以下</option>
                                <option value="¥5,000–¥10,000">¥5,000–¥10,000</option>
                                <option value="¥10,000–¥20,000">¥10,000–¥20,000</option>
                            </select>
                        </div>
                        <!-- 地区筛选下拉 -->
                        <div>
                            <select id="mobileAreaFilter" class="mobile-filter-select">
                                <option value="">所在地区</option>
                                <option value="千代田区">千代田区</option>
                                <option value="中央区">中央区</option>
                                <option value="港区">港区</option>
                                <option value="新宿区">新宿区</option>
                                <option value="渋谷区">渋谷区</option>
                                <option value="杉並区">杉並区</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- 菜系筛选标签 -->
                <div class="filter-group">
                    <div class="filter-buttons">
                        <button onclick="filterByCuisine('')" class="filter-btn active">全部</button>
                        <button onclick="filterByCuisine('拉面')" class="filter-btn">拉面</button>
                        <button onclick="filterByCuisine('猪排')" class="filter-btn">猪排</button>
                        <button onclick="filterByCuisine('荞麦')" class="filter-btn">荞麦</button>
                        <button onclick="filterByCuisine('天妇罗')" class="filter-btn">天妇罗</button>
                        <button onclick="filterByCuisine('法国料理')" class="filter-btn">法国料理</button>
                        <button onclick="filterByCuisine('印度料理')" class="filter-btn">印度料理</button>
                        <button onclick="filterByCuisine('日本料理')" class="filter-btn">日本料理</button>
                        <button onclick="filterByCuisine('寿司')" class="filter-btn">寿司</button>
                        <button onclick="filterByCuisine('烧鸟')" class="filter-btn">烧鸟</button>
                        <button onclick="filterByCuisine('意大利料理')" class="filter-btn">意大利料理</button>
                        <button onclick="filterByCuisine('鳗鱼')" class="filter-btn">鳗鱼</button>
                        <button onclick="filterByCuisine('饭团')" class="filter-btn">饭团</button>
                        <button onclick="filterByCuisine('西餐')" class="filter-btn">西餐</button>
                    </div>
                    <div
                        style="margin-top: var(--spacing-lg); display: flex; justify-content: space-between; align-items: center;">
                        <button onclick="resetFilters()" class="reset-btn">重置筛选</button>
                        <span id="resultCount" class="result-count"></span>
                    </div>
                </div>
            </div>

            <!-- 桌面端筛选 -->
            <div class="desktop-filter">
                <div class="filter-group">
                    <div class="filter-group-title">价格区间</div>
                    <div class="filter-buttons">
                        <button onclick="filterByPrice('')" class="filter-btn active">全部价位</button>
                        <button onclick="filterByPrice('¥5,000 以下')" class="filter-btn">¥5,000 以下</button>
                        <button onclick="filterByPrice('¥5,000–¥10,000')" class="filter-btn">¥5,000–¥10,000</button>
                        <button onclick="filterByPrice('¥10,000–¥20,000')" class="filter-btn">¥10,000–¥20,000</button>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-group-title">菜系类型</div>
                    <div class="filter-buttons">
                        <button onclick="filterByCuisine('')" class="filter-btn active">全部菜系</button>
                        <button onclick="filterByCuisine('拉面')" class="filter-btn">拉面</button>
                        <button onclick="filterByCuisine('猪排')" class="filter-btn">猪排</button>
                        <button onclick="filterByCuisine('荞麦')" class="filter-btn">荞麦</button>
                        <button onclick="filterByCuisine('天妇罗')" class="filter-btn">天妇罗</button>
                        <button onclick="filterByCuisine('法国料理')" class="filter-btn">法国料理</button>
                        <button onclick="filterByCuisine('印度料理')" class="filter-btn">印度料理</button>
                        <button onclick="filterByCuisine('日本料理')" class="filter-btn">日本料理</button>
                        <button onclick="filterByCuisine('寿司')" class="filter-btn">寿司</button>
                        <button onclick="filterByCuisine('烧鸟')" class="filter-btn">烧鸟</button>
                        <button onclick="filterByCuisine('意大利料理')" class="filter-btn">意大利料理</button>
                        <button onclick="filterByCuisine('鳗鱼')" class="filter-btn">鳗鱼</button>
                        <button onclick="filterByCuisine('饭团')" class="filter-btn">饭团</button>
                        <button onclick="filterByCuisine('西餐')" class="filter-btn">西餐</button>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-group-title">所在地区</div>
                    <div class="filter-buttons">
                        <button onclick="filterByArea('')" class="filter-btn active">全部地区</button>
                        <button onclick="filterByArea('千代田区')" class="filter-btn">千代田区</button>
                        <button onclick="filterByArea('中央区')" class="filter-btn">中央区</button>
                        <button onclick="filterByArea('港区')" class="filter-btn">港区</button>
                        <button onclick="filterByArea('新宿区')" class="filter-btn">新宿区</button>
                        <button onclick="filterByArea('涩谷区')" class="filter-btn">涩谷区</button>
                        <button onclick="filterByArea('杉并区')" class="filter-btn">杉并区</button>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <button onclick="resetFilters()" class="reset-btn">重置筛选</button>
                    <span id="resultCountDesktop" class="result-count"></span>
                </div>
            </div>
        </section>

        <section>
            <h2 class="title-section">精选餐厅推荐</h2>
            <div id="restaurantList" class="restaurant-grid">
            </div>
        </section>
    </div>

    <script>
        let restaurants = [];
        let allRestaurants = [];

        // 从JSON文件加载餐厅数据
        async function loadRestaurants() {
            try {
                const response = await fetch('tokyo-under-20k-restaurants.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                console.log('加载的数据:', data.length, '家餐厅');

                // 转换JSON数据格式为页面所需格式
                allRestaurants = data.map(restaurant => ({
                    name: restaurant.name_en,
                    jpName: restaurant.name_jp,
                    type: restaurant.michelin_type || "推荐",
                    cuisine: mapCuisineType(restaurant.cuisine),
                    area: restaurant.ward,
                    rating: restaurant.tabelog_rating,
                    price: restaurant.price_estimate,
                    priceTier: mapPriceTier(restaurant.price_estimate),
                    reservable: restaurant.online_booking ? "是" : "否",
                    reason: restaurant.tabelog_review_summary,
                    website: restaurant.website
                }));

                restaurants = allRestaurants;
                console.log('转换后的数据:', restaurants.length, '家餐厅');
                renderList(restaurants);
                updateFilterButtons();
            } catch (error) {
                console.error('加载餐厅数据失败:', error);
                // 显示错误信息
                const restaurantList = document.getElementById('restaurantList');
                if (restaurantList) {
                    restaurantList.innerHTML =
                        '<div class="col-span-full text-center text-red-600 p-8">数据加载失败，请刷新页面重试<br><small>错误信息: ' + error.message + '</small></div>';
                }
            }
        }

        // 映射菜系类型（现在都是中文，直接返回）
        function mapCuisineType(cuisine) {
            return cuisine;
        }

        // 映射价格区间
        function mapPriceTier(priceEstimate) {
            if (!priceEstimate) return "未知";

            // 提取价格数字，处理各种格式
            const priceMatch = priceEstimate.match(/¥(\d+(?:,\d+)?)/g);
            if (!priceMatch) return "未知";

            const prices = priceMatch.map(p => parseInt(p.replace(/¥|,/g, '')));
            const maxPrice = Math.max(...prices);

            if (maxPrice <= 5000) return "¥5,000 以下";
            if (maxPrice <= 10000) return "¥5,000–¥10,000";
            return "¥10,000–¥20,000";
        }

        // 更新筛选按钮
        function updateFilterButtons() {
            // 获取所有独特的菜系类型
            const cuisines = [...new Set(allRestaurants.map(r => r.cuisine))];
            const areas = [...new Set(allRestaurants.map(r => r.area))];

            // 更新移动端菜系按钮
            updateCuisineButtons(cuisines);
            // 更新地区选择器
            updateAreaSelectors(areas);
        }

        function updateCuisineButtons(cuisines) {
            console.log('更新菜系按钮:', cuisines);

            // 移动端菜系按钮更新
            const mobileContainer = document.querySelector('.mobile-filter .filter-buttons');
            if (mobileContainer) {
                // 保留"全部"按钮，清除其他按钮
                const buttons = mobileContainer.querySelectorAll('button:not([onclick="filterByCuisine(\'\')"])');
                buttons.forEach(btn => btn.remove());

                // 添加新的菜系按钮
                cuisines.sort().forEach(cuisine => {
                    const button = document.createElement('button');
                    button.onclick = () => filterByCuisine(cuisine);
                    button.className = 'filter-btn';
                    button.textContent = cuisine;
                    mobileContainer.appendChild(button);
                });
            }

            // 桌面端菜系按钮更新
            const desktopContainer = document.querySelector('.desktop-filter .filter-group:nth-child(2) .filter-buttons');
            if (desktopContainer) {
                // 保留"全部"按钮，清除其他按钮
                const buttons = desktopContainer.querySelectorAll('button:not([onclick="filterByCuisine(\'\')"])');
                buttons.forEach(btn => btn.remove());

                // 添加新的菜系按钮
                cuisines.sort().forEach(cuisine => {
                    const button = document.createElement('button');
                    button.onclick = () => filterByCuisine(cuisine);
                    button.className = 'filter-btn';
                    button.textContent = cuisine;
                    desktopContainer.appendChild(button);
                });
            }
        }

        function updateAreaSelectors(areas) {
            console.log('更新地区选择器:', areas);

            // 更新移动端地区选择器
            const mobileAreaSelect = document.getElementById('mobileAreaFilter');
            if (mobileAreaSelect) {
                // 清除现有选项（保留第一个"所在地区"选项）
                while (mobileAreaSelect.children.length > 1) {
                    mobileAreaSelect.removeChild(mobileAreaSelect.lastChild);
                }

                // 添加新的地区选项
                areas.sort().forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    mobileAreaSelect.appendChild(option);
                });
            }

            // 更新桌面端地区按钮
            const desktopContainer = document.querySelector('.desktop-filter .filter-group:nth-child(3) .filter-buttons');
            if (desktopContainer) {
                // 保留"全部"按钮，清除其他按钮
                const buttons = desktopContainer.querySelectorAll('button:not([onclick="filterByArea(\'\')"])');
                buttons.forEach(btn => btn.remove());

                // 添加新的地区按钮
                areas.sort().forEach(area => {
                    const button = document.createElement('button');
                    button.onclick = () => filterByArea(area);
                    button.className = 'filter-btn';
                    button.textContent = area;
                    desktopContainer.appendChild(button);
                });
            }
        }

        const list = document.getElementById("restaurantList");

        function renderList(data) {
            if (!list) return;

            list.innerHTML = data.map(r => {
                // 处理米其林等级显示
                let typeDisplay = '';
                let typeClass = '';

                if (r.type === '一星') {
                    typeDisplay = '一星';
                    typeClass = 'michelin-badge michelin-one-star';
                } else if (r.type === '二星') {
                    typeDisplay = '二星';
                    typeClass = 'michelin-badge michelin-two-star';
                } else if (r.type === '必比登') {
                    typeDisplay = '必比登';
                    typeClass = 'michelin-badge michelin-bib';
                } else {
                    typeDisplay = '推荐';
                    typeClass = 'michelin-badge michelin-recommended';
                }

                return `
        <div class="restaurant-card">
          <span class="${typeClass}">${typeDisplay}</span>
          <h3 class="restaurant-title">${r.jpName || r.name}</h3>
          <p class="restaurant-subtitle">${r.name || r.jpName}</p>
          <div class="restaurant-info-grid">
            <div class="restaurant-info-item"><span class="restaurant-info-label">菜系：</span>${r.cuisine}</div>
            <div class="restaurant-info-item"><span class="restaurant-info-label">地区：</span>${r.area}</div>
            <div class="restaurant-info-item"><span class="restaurant-info-label">评分：</span>${r.rating ? r.rating + '/5' : '暂无评分'}</div>
            <div class="restaurant-info-item"><span class="restaurant-info-label">价格：</span>${r.price}</div>
          </div>
          <div class="reservation-status ${r.reservable === '是' ? 'reservation-available' : 'reservation-unavailable'}">
            ${r.reservable === '是' ? '可预约' : '不可预约'}
          </div>
          <p class="restaurant-description">${r.reason}</p>
          ${r.website ? `<a href="${r.website}" target="_blank" class="restaurant-link">查看官网</a>` : ''}
        </div>`;
            }).join("");

            // 更新结果计数
            updateResultCount(data.length);
        }

        let currentFilters = {
            price: '',
            cuisine: '',
            area: ''
        };

        function filterByPrice(priceTier) {
            currentFilters.price = priceTier;
            updateButtons('.filter-btn', `[onclick="filterByPrice('${priceTier}')"]`);
            // 同步移动端下拉选择
            document.getElementById('mobilePriceFilter').value = priceTier;
            applyFilters();
        }

        function filterByCuisine(cuisine) {
            currentFilters.cuisine = cuisine;
            updateButtons('.filter-btn', `[onclick="filterByCuisine('${cuisine}')"]`);
            applyFilters();
        }

        function filterByArea(area) {
            currentFilters.area = area;
            updateButtons('.filter-btn', `[onclick="filterByArea('${area}')"]`);
            // 同步移动端下拉选择
            document.getElementById('mobileAreaFilter').value = area;
            applyFilters();
        }

        function updateButtons(selector, activeSelector) {
            document.querySelectorAll(selector).forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(activeSelector);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function updateResultCount(count) {
            const countText = `共 ${count} 家餐厅`;
            const resultCountEl = document.getElementById('resultCount');
            const resultCountDesktopEl = document.getElementById('resultCountDesktop');
            if (resultCountEl) resultCountEl.textContent = countText;
            if (resultCountDesktopEl) resultCountDesktopEl.textContent = countText;
        }

        function applyFilters() {
            let result = [...restaurants];

            if (currentFilters.price) {
                result = result.filter(r => r.priceTier === currentFilters.price);
            }

            if (currentFilters.cuisine) {
                result = result.filter(r => r.cuisine === currentFilters.cuisine);
            }

            if (currentFilters.area) {
                result = result.filter(r => r.area === currentFilters.area);
            }

            renderList(result);
        }

        function resetFilters() {
            currentFilters = {
                price: '',
                cuisine: '',
                area: ''
            };

            // 重置移动端下拉选择
            document.getElementById('mobilePriceFilter').value = '';
            document.getElementById('mobileAreaFilter').value = '';

            updateButtons('.filter-btn', `[onclick="filterByPrice('')"]`);
            updateButtons('.filter-btn', `[onclick="filterByCuisine('')"]`);
            updateButtons('.filter-btn', `[onclick="filterByArea('')"]`);

            renderList(restaurants);
        }

        // 移动端下拉选择事件监听
        document.getElementById('mobilePriceFilter').addEventListener('change', function () {
            filterByPrice(this.value);
        });

        document.getElementById('mobileAreaFilter').addEventListener('change', function () {
            filterByArea(this.value);
        });

        // 页面加载时初始化数据
        document.addEventListener('DOMContentLoaded', function () {
            loadRestaurants();
        });
    </script>
</body>

</html>